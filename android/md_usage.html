<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BGXpress Service: BGXpress Service Usage</title>
<!-- load the fonts we want to use -->
<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700|Roboto+Mono:400' rel='stylesheet' type='text/css'>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="silabs-logo-white.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BGXpress Service
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_usage.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">BGXpress Service Usage </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Using BGXpressService</h2>
<h3>Adding BGXpressService to your Android project</h3>
<p>To use the BGXpressService in your Android app, follow these steps:</p>
<ol type="1">
<li>Add the files BGXpressService.java and BusMode.java into your Android app.</li>
<li>Declare the BGXpressService in your AndroidManifest.xml file like this: <pre class="fragment"> &lt;service
     android:name=".BGXpressService"
     android:exported="false"&gt;
     &lt;meta-data android:name="DMS_API_KEY" android:value="&lt;YOUR DMS API KEY HERE&gt;"/&gt;
 &lt;/service&gt;
</pre></li>
<li>If you do not yet have a <code>DMS_API_KEY</code>, supply an empty string for now.</li>
<li>Add the following declarations to your AndroidManifest.xml file: <pre class="fragment"> &lt;uses-feature
     android:name="android.hardware.bluetooth_le"
     android:required="true" /&gt;

 &lt;uses-permission android:name="android.permission.BLUETOOTH" /&gt;
 &lt;uses-permission android:name="android.permission.BLUETOOTH_ADMIN" /&gt;
 &lt;uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" /&gt;
 &lt;uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" /&gt;
 &lt;uses-permission android:name="android.permission.INTERNET" /&gt;
 &lt;uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" /&gt;
</pre></li>
</ol>
<h3>Setup Bluetooth in your main activty</h3>
<p>In the onCreate method of the main activity of your app, you will need to perform the following operations:</p>
<ol type="1">
<li>Verify the system supports Bluetooth Low Energy: <code>getPackageManager().hasSystemFeature(PackageManager.FEATURE_BLUETOOTH_LE)</code></li>
<li>Request permission to access device location (this is required in order to use BLE): <code>requestPermissions(new String[]{Manifest.permission.ACCESS_COARSE_LOCATION}, PERMISSION_REQUEST_COARSE_LOCATION);</code></li>
<li>Start the BGXpressService: <code>startService(new Intent(this, BGXpressService.class));</code></li>
</ol>
<p>You should register a BroadcastReceiver to receive broadcast intents for the following: <code>BGXpressService.BGX_SCAN_DEVICE_DISCOVERED</code>, <code>BGXpressService.BGX_CONNECTION_STATUS_CHANGE</code>, and <code>BGXpressService.BGX_SCAN_MODE_CHANGE</code>.</p>
<p>Do not scan for devices until onRequestPermissionsResult is called by the operating system to grant permission to access the device location.</p>
<p>In your onResume() method if you have been granted permission to acccess the device location and BluetoothAdapter.getDefaultAdapter() is not null, check to see if the default adapter is enabled by calling <code>BluetoothAdapter.getDefaultAdapter().isEnabled()</code>. If it is not enabled then create an Intent for <code>BluetoothAdapter.ACTION_REQUEST_ENABLE</code> and start an activity wth this Intent.</p>
<h3>Device Discovery</h3>
<p>When three conditions have been met: you determine the system supports Bluetooth Low Energy, onRequestPermissionsResult was called indicating you were granted permission to use the device location, and the default bluetooth adapter is enabled, then you can scan for BGX devices by calling: </p><pre class="fragment">`BGXpressService.startActionStartScan(Context)`
</pre><p>You will receive broadcast intents in your broadcast receiver with the action <code>BGXpressService.BGX_SCAN_DEVICE_DISCOVERED</code> as devices are discovered. This intent will contain an Extra which is a HashMap&lt;String, String&gt; containing the keys <em>name</em>, <em>uuid</em>, and <em>rssi</em>. The <em>name</em> key is the device name, the <em>uuid</em> key is the device uuid which you will use to connect to the device, and <em>rssi</em> contains the signal strength of the device.</p>
<h3>Connecting to a BGX</h3>
<p>To connect to a device, call <code>BGXpressService.startActionBGXConnect(context, deviceUUID)</code> where deviceUUID is the uuid you were given in the HashMap for the device. The app will receive broadcast intents of type <code>BGXpressService.BGX_CONNECTION_STATUS_CHANGE</code> as the connection occurs.</p>
<p>When the <code>bgx-connection-status</code> extra inside the <code>BGXpressService.BGX_CONNECTION_STATUS_CHANGE</code> Intent is <code>CONNECTED</code>, the device is connected.</p>
<h4>Detecting device Changes</h4>
<p>You should register to receive broadcast intents for the following actions:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Action  </th><th class="markdownTableHeadNone">Purpose  </th><th class="markdownTableHeadNone">Extras   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>BGXpressService.BGX_MODE_STATE_CHANGE</code>  </td><td class="markdownTableBodyNone">Indicates BusMode has been read or has changed  </td><td class="markdownTableBodyNone">busmode   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>BGXpressService.BGX_DATA_RECEIVED</code>  </td><td class="markdownTableBodyNone">Indicates data has been received  </td><td class="markdownTableBodyNone">data   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>BGXpressService.BGX_DEVICE_INFO</code>  </td><td class="markdownTableBodyNone">Contains information about the BGX which is needed for DMS/OTA  </td><td class="markdownTableBodyNone">bgx-device-uuid, bgx-part-id   </td></tr>
</table>
<h4>Read/Write Serial data</h4>
<p>When data is received from a connected BGX, the BGXpressService will send a broadcast intent of type BGXpressService.BGX_DATA_RECEIVED containing the data. To write data to the connected BGX, send a <code>BGXpressService.ACTION_WRITE_SERIAL_DATA</code> Intent like this: </p><pre class="fragment">    Intent writeIntent = new Intent(BGXpressService.ACTION_WRITE_SERIAL_DATA);
    writeIntent.putExtra("value", text2send);
    writeIntent.setClass(mContext, BGXpressService.class);
    startService(writeIntent);
</pre><h4>Bus Mode</h4>
<p>To change the BusMode, use the following method to send an Intent to BGXpressService: </p><pre class="fragment">    Intent intent = new Intent(BGXpressService.ACTION_WRITE_BUS_MODE);
    intent.setClass(this, BGXpressService.class);
    intent.putExtra("busmode", busMode);
    startService(intent);
</pre><p>Changes to the BusMode will be indicated by receiving a broadcast intent with the action <code>BGXpressService.BGX_MODE_STATE_CHANGE</code> containing the extra <em>busmode</em>.</p>
<h4>Disconnecting from a BGX</h4>
<p>To disconnect from the connected BGX: </p><pre class="fragment">Intent intent = new Intent(BGXpressService.ACTION_BGX_DISCONNECT);
intent.setClass(mContext, BGXpressService.class);
startService(intent);
</pre><p>When the BGX is disconnected, you will receive a broadcast Intent with the action <code>BGXpressService.BGX_CONNECTION_STATUS_CHANGE</code> where the <em>bgx-connection-status</em> will have the value DISCONNECTED.</p>
<h4>Get available firmware using DMS</h4>
<p>To request the list of available firmware, send the following Intent: </p><pre class="fragment">Intent intent = new Intent(BGXpressService.ACTION_DMS_GET_VERSIONS);
intent.setClass(this, BGXpressService.class);
intent.putExtra("bgx-part-id", mBGXPartID);
startService(intent);
</pre><p>When the list has been retrieved you will receive a broadcast intent with the action <code>BGXpressService.DMS_VERSIONS_AVAILABLE</code> which contains the list in the form of JSON under the extra <em>versions-available-json</em>. The JSON will parse into an array containing firmware version records with the following keys:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">key  </th><th class="markdownTableHeadNone">type   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">version  </td><td class="markdownTableBodyNone">string   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">tag  </td><td class="markdownTableBodyNone">string (may be empty)   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">size  </td><td class="markdownTableBodyNone">int (number of bytes)   </td></tr>
</table>
<h4>Get firmware image using DMS</h4>
<p>To request a specific version of firmware be loaded, the following Intent should be sent:</p>
<p>Intent intent = new Intent(BGXpressService.ACTION_DMS_REQUEST_VERSION); </p><pre class="fragment">                intent.putExtra("bgx-part-id", bgx_part_id); // This is the part ID that was provided in the BGXpressService.BGX_DEVICE_INFO intent as the extra *bgx-partd-id*
                intent.putExtra("dms-version", dms_version); // This is the DMS version provided in the *version* field of the JSON record.

                intent.setClass(mContext, BGXpressService.class);
</pre><p>When the firmware image is loaded onto your mobile device, you will receive a broadcast intent with the action <code>BGXpressService.DMS_VERSION_LOADED</code> containing an extra called <em>file_path</em>.</p>
<h4>Updating a BGX using a firmware image</h4>
<p>To install a firmware image onto the connected BGX, send the following Intent: </p><pre class="fragment">Intent updateIntent = new Intent(mContext, BGXpressService.class);
updateIntent.setAction(ACTION_OTA_WITH_IMAGE);
updateIntent.putExtra("image_path", firmwareImageFilePath);
startService(updateIntent);
</pre><p>As the update installs, you will receive a series of broadcast intents with the action <code>BGXpressService.OTA_STATUS_MESSAGE</code> with the following Extras:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Extra  </th><th class="markdownTableHeadNone">Type  </th><th class="markdownTableHeadNone">Default Value  </th><th class="markdownTableHeadNone">Meaning   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ota_failed  </td><td class="markdownTableBodyNone">boolean  </td><td class="markdownTableBodyNone">false  </td><td class="markdownTableBodyNone">If this value is true, it means that the OTA failed.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">ota_status  </td><td class="markdownTableBodyNone">OTA_STATUS  </td><td class="markdownTableBodyNone">n/a  </td><td class="markdownTableBodyNone">This is an enum indicating the status of the OTA. The values are described in the table below.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">bytes_sent  </td><td class="markdownTableBodyNone">int  </td><td class="markdownTableBodyNone">-1  </td><td class="markdownTableBodyNone">Indicates the number of bytes that has been uploaded to the BGX device. This is only present when the OTA status is Installing.   </td></tr>
</table>
<h5>Canceling an OTA Update</h5>
<p>To cancel an OTA Update in progress, send the following Intent: </p><pre class="fragment">Intent intent = new Intent();
intent.setAction(BGXpressService.ACTION_OTA_CANCEL);
intent.setClass(mContext, BGXpressService.class);
startService(intent);
</pre><h5>OTA_Status Values</h5>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">OTA_Status Value  </th><th class="markdownTableHeadNone">Meaning   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Invalid  </td><td class="markdownTableBodyNone">Should never see this. It indicates an error has occurred.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Idle  </td><td class="markdownTableBodyNone">No OTA is happening   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Downloading  </td><td class="markdownTableBodyNone">The firmware image is being downloaded through DMS   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Installing  </td><td class="markdownTableBodyNone">The firmware iamge is being sent to the BGX device   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Finishing  </td><td class="markdownTableBodyNone">The firmware image has been written and the bgx is being commanded to load it   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Finished  </td><td class="markdownTableBodyNone">The BGX has acknowledged the command to load the firmware. The BGX is rebooting   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">UserCanceled  </td><td class="markdownTableBodyNone">The intent ACTION_OTA_CACNCEL has been received and the OTA operation is being canceled   </td></tr>
</table>
</div><div style="border-top: 1px solid #c0c0c0; margin-top: 8px; font-size: 12px; color: #c0c0c0;"><span style="float: left;">Copyright 2018 Silicon Labs</span><span style="float: right">536bbb94 Tue Sep 11 14:27:22 CDT 2018</span></div></div><!-- pagefooter-contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.14-->
<!-- start footer part -->
</body>
</html>
